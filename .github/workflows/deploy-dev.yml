name: ðŸš€ Deploy Development (Coolify)

on:
  push:
    branches: [ develop ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

env:
  NODE_VERSION: '22'
  ENVIRONMENT: 'dev'

jobs:
  pre-deploy:
    name: ðŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: npm ci --force

      - name: ðŸ§ª Run quick tests
        run: npm test -- --passWithNoTests --watchAll=false
        env:
          CI: true

      - name: ðŸ” Run ESLint
        run: npm run lint

  deploy-dev:
    name: ðŸš€ Deploy to Development
    runs-on: ubuntu-latest
    needs: pre-deploy
    environment: development
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Coolify Development
        run: |
          echo "ðŸš€ Triggering Coolify deployment for development..."
          
          if [ -n "${{ secrets.COOLIFY_WEBHOOK_DEV }}" ] && [ -n "${{ secrets.COOLIFY_WEBHOOK_TOKEN }}" ]; then
            curl --request GET "${{ secrets.COOLIFY_WEBHOOK_DEV }}" \
              --header "Authorization: Bearer ${{ secrets.COOLIFY_WEBHOOK_TOKEN }}" \
              --max-time 30 \
              --retry 3 \
              --retry-delay 5 \
              --fail-with-body || {
                echo "âŒ Webhook falhou"
                echo "â„¹ï¸ Verifique se o webhook URL e token estÃ£o corretos"
                echo "â„¹ï¸ URL: ${{ secrets.COOLIFY_WEBHOOK_DEV }}"
                exit 1
              }
            echo "âœ… Development deployment triggered!"
          else
            echo "âš ï¸ COOLIFY_WEBHOOK_DEV ou COOLIFY_WEBHOOK_TOKEN not configured"
            echo "â„¹ï¸ Configure os secrets ou ative Auto-Deploy no Coolify"
            echo "â„¹ï¸ Como alternativa, o push para 'develop' pode ter triggered automaticamente"
          fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Development Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Development" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: develop" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Compose File**: docker-compose.dev.yml" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Status: TRIGGERED" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Development deployment triggered successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Access**: [Development Environment](https://${{ vars.DEV_DOMAIN }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip**: Check your Coolify dashboard for deployment status" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš¨ **Development deployment trigger failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”§ **Next Steps**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check if Auto-Deploy is enabled in Coolify" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify COOLIFY_WEBHOOK_DEV and COOLIFY_WEBHOOK_TOKEN in GitHub secrets" >> $GITHUB_STEP_SUMMARY
            echo "3. Check Coolify server and webhook configuration" >> $GITHUB_STEP_SUMMARY
          fi 