name: ðŸŒŸ Deploy Production (Coolify)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '22'
  ENVIRONMENT: 'production'

jobs:
  pre-deploy:
    name: ðŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      deploy: ${{ steps.should-deploy.outputs.deploy }}
      trigger: ${{ steps.should-deploy.outputs.trigger }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Check if should deploy
        id: should-deploy
        run: |
          # Se for trigger por tag, sempre deployr
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "trigger=tag" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸ Deploy triggered by tag: ${{ github.ref }}"
          else
            # Se for push na main, verificar se foi um merge de PR com versÃ£o
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qE 'v[0-9]+\.[0-9]+\.[0-9]+'; then
              echo "deploy=true" >> $GITHUB_OUTPUT
              echo "trigger=main" >> $GITHUB_OUTPUT
              echo "ðŸš€ Deploy triggered by main push with version"
            else
              echo "deploy=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping deploy - no version found in commit"
            fi
          fi

      - name: ðŸ“¦ Setup Node.js
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        if: steps.should-deploy.outputs.deploy == 'true'
        run: npm ci --force

      - name: ðŸ” Run ESLint
        if: steps.should-deploy.outputs.deploy == 'true'
        run: npm run lint

      - name: ðŸ§ª Run full test suite
        if: steps.should-deploy.outputs.deploy == 'true'
        run: npm run test:coverage
        env:
          CI: true

      - name: ðŸ”’ Security audit
        if: steps.should-deploy.outputs.deploy == 'true'
        run: npm audit --audit-level=high

      - name: ðŸ“Š Upload Coverage for Production Deploy
        if: steps.should-deploy.outputs.deploy == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: production-coverage
          path: coverage/
          retention-days: 30

  deploy-prod:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: pre-deploy
    if: needs.pre-deploy.outputs.deploy == 'true'
    environment: production
    timeout-minutes: 15
    
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Se for tag, extrair da tag
            VERSION=${GITHUB_REF#refs/tags/}
            echo "ðŸ·ï¸ Version from tag: ${VERSION}"
          else
            # Se for push na main, extrair do commit/PR
            VERSION=$(git log -1 --pretty=%B | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
            if [ -z "$VERSION" ]; then
              # Buscar na Ãºltima tag como fallback
              VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
              echo "ðŸ”„ Using latest tag as fallback: ${VERSION}"
            fi
            echo "ðŸš€ Version from commit: ${VERSION}"
          fi
          
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Final version: ${VERSION}"

      - name: ðŸš€ Deploy to Coolify Production
        run: |
          echo "ðŸŒŸ Triggering Coolify deployment for production..."
          
          if [ -n "${{ secrets.COOLIFY_WEBHOOK_PROD }}" ] && [ -n "${{ secrets.COOLIFY_WEBHOOK_TOKEN }}" ]; then
            curl --request GET "${{ secrets.COOLIFY_WEBHOOK_PROD }}" \
              --header "Authorization: Bearer ${{ secrets.COOLIFY_WEBHOOK_TOKEN }}" \
              --max-time 60 \
              --retry 3 \
              --retry-delay 10 \
              --fail-with-body || {
                echo "âŒ Webhook falhou"
                echo "â„¹ï¸ Verifique se o webhook URL e token estÃ£o corretos"
                echo "â„¹ï¸ URL: ${{ secrets.COOLIFY_WEBHOOK_PROD }}"
                exit 1
              }
            echo "âœ… Production deployment triggered!"
          else
            echo "âš ï¸ COOLIFY_WEBHOOK_PROD ou COOLIFY_WEBHOOK_TOKEN not configured"
            echo "â„¹ï¸ Configure os secrets ou ative Auto-Deploy no Coolify"
            echo "â„¹ï¸ Como alternativa, a tag pode ter triggered automaticamente"
          fi

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸŒŸ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ env.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Compose File**: docker-compose.yml" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Status: TRIGGERED" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Production deployment triggered successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒŸ **Version ${{ env.VERSION }} deployment started!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Access**: [Production Environment](https://${{ vars.PROD_DOMAIN }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip**: Check your Coolify dashboard for deployment status" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Status: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš¨ **Production deployment trigger failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”§ **Next Steps**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check if Auto-Deploy is enabled in Coolify" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify COOLIFY_WEBHOOK_PROD and COOLIFY_WEBHOOK_TOKEN in GitHub secrets" >> $GITHUB_STEP_SUMMARY
            echo "3. Check Coolify server and webhook configuration" >> $GITHUB_STEP_SUMMARY
          fi

  post-deploy:
    name: ðŸ“¢ Post-Deploy Status
    runs-on: ubuntu-latest
    needs: deploy-prod
    if: always()
    
    steps:
      - name: ðŸ·ï¸ Get version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: ðŸŽ‰ Success Notification
        if: needs.deploy-prod.result == 'success'
        run: |
          echo "## ðŸŽ‰ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒŸ Version ${{ env.VERSION }} deployment triggered!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment triggered successfully**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Production environment deployment started**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Production URL**: https://${{ vars.PROD_DOMAIN }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸš¨ Failure Notification
        if: needs.deploy-prod.result == 'failure'
        run: |
          echo "## ðŸš¨ Production Deployment Issues!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âŒ Critical Issue Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš¨ **Production deployment trigger failed**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Please check the Coolify logs and application status**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Coolify deployment logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify webhook configuration" >> $GITHUB_STEP_SUMMARY
          echo "3. Investigate and fix issues before next deployment" >> $GITHUB_STEP_SUMMARY
          
          exit 1 