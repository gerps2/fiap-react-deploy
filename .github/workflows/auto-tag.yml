name: ðŸ·ï¸ Auto Tag on Main Merge

on:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '22'

jobs:
  auto-tag:
    name: ðŸ·ï¸ Create Release Tag
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip-tag]') && !contains(github.event.head_commit.message, 'Merge pull request')"
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Extract version from commit or PR
        id: version
        run: |
          # Buscar versÃ£o no commit message (formato: v1.2.3 ou 1.2.3)
          VERSION=$(git log -1 --pretty=%B | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          
          # Se nÃ£o encontrou, buscar no tÃ­tulo do Ãºltimo PR merged
          if [ -z "$VERSION" ]; then
            LAST_MERGE=$(git log --merges -1 --pretty=%B)
            VERSION=$(echo "$LAST_MERGE" | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+' | head -1)
          fi
          
          # Se ainda nÃ£o encontrou, usar semver baseado na Ãºltima tag
          if [ -z "$VERSION" ]; then
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "ðŸ·ï¸ Ãšltima tag encontrada: $LAST_TAG"
            
            # Incrementar patch version
            VERSION=$(echo $LAST_TAG | sed 's/v//' | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
            VERSION="v$VERSION"
            echo "ðŸ”„ Auto-incrementando para: $VERSION"
          fi
          
          # Remover 'v' se existir e recolocar para padronizar
          VERSION=$(echo $VERSION | sed 's/^v//')
          VERSION="v$VERSION"
          
          echo "ðŸŽ¯ VersÃ£o final: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=$(echo $VERSION | sed 's/v//')" >> $GITHUB_OUTPUT

      - name: ðŸ” Check if tag already exists
        id: tag-check
        run: |
          if git rev-parse "refs/tags/${{ steps.version.outputs.VERSION }}" >/dev/null 2>&1; then
            echo "âš ï¸ Tag ${{ steps.version.outputs.VERSION }} jÃ¡ existe"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag ${{ steps.version.outputs.VERSION }} Ã© nova"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¦ Setup Node.js
        if: steps.tag-check.outputs.exists == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        if: steps.tag-check.outputs.exists == 'false'
        run: npm ci --force

      - name: ðŸ§ª Run tests
        if: steps.tag-check.outputs.exists == 'false'
        run: npm run test -- --passWithNoTests --watchAll=false
        env:
          CI: true

      - name: ðŸ” Run ESLint
        if: steps.tag-check.outputs.exists == 'false'
        run: npm run lint

      - name: ðŸ·ï¸ Create and push tag
        if: steps.tag-check.outputs.exists == 'false'
        run: |
          # Configurar git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Gerar release notes baseado nos commits desde a Ãºltima tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            RELEASE_NOTES=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          else
            RELEASE_NOTES=$(git log --pretty=format:"- %s" --no-merges -10)
          fi
          
          # Criar tag anotada com release notes
          git tag -a "${{ steps.version.outputs.VERSION }}" -m "ðŸš€ Release ${{ steps.version.outputs.VERSION }}

          ## ðŸ“‹ Changes:
          $RELEASE_NOTES
          
          ## ðŸ”— Links:
          - **Commit**: ${{ github.sha }}
          - **Author**: ${{ github.actor }}
          - **Deployment**: Automatic via Coolify"
          
          # Push da tag
          git push origin "${{ steps.version.outputs.VERSION }}"
          
          echo "âœ… Tag ${{ steps.version.outputs.VERSION }} criada e enviada!"

      - name: ðŸ“Š Create Release Summary
        if: steps.tag-check.outputs.exists == 'false'
        run: |
          echo "## ðŸ·ï¸ Release Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Tag Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ steps.version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… Tag created automatically" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”„ Production deployment will be triggered automatically" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸ“Š Check the deploy-prod workflow for deployment status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Release ${{ steps.version.outputs.VERSION }} is ready for production!**" >> $GITHUB_STEP_SUMMARY

      - name: âš ï¸ Tag Already Exists
        if: steps.tag-check.outputs.exists == 'true'
        run: |
          echo "## âš ï¸ Tag Already Exists" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tag \`${{ steps.version.outputs.VERSION }}\` already exists." >> $GITHUB_STEP_SUMMARY
          echo "No new tag was created." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip**: Include a version number in your PR title or commit message to create a new tag." >> $GITHUB_STEP_SUMMARY 